<div id="mapcontainer">
  <div id="floating-panel">
      <input onclick="clearMarkers();" type=button value="Hide Markers">
      <input onclick="showMarkers();" type=button value="Show All Markers">
      <input onclick="deleteMarkers();" type=button value="Delete Markers">
    </div>
  <div id="map"></div>
</div>
<script>

  let map;
  let geocoder;
  let myLatLng;
  let marker;
  let markers = <%== @current_user.locations.to_json %>;

  function initMap() {
    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(document.getElementById("map"), {
      center: {lat: 30, lng: 0 },
      zoom: 2,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    for (let i = 0; i < markers.length; i++) {
      const m = markers[i];
      const latLng = new google.maps.LatLng(m.latitude, m.longitude);
      let marker = new google.maps.Marker({
        position: latLng,
        map: map
      });
      var infowindow = new google.maps.InfoWindow({
        content: m.country
      });
      marker.addListener('click', function() {
        infowindow.open(map, marker);
      });
    }

    map.addListener('click', function(e) {
      placeMarkerAndPanTo(e.latLng, map);
    });
  };

  function placeMarkerAndPanTo(latLng, map) {
    let marker = new google.maps.Marker({
      position: latLng,
      map: map
    });
    map.panTo(latLng);
    markers.push(marker);
    geocoder.geocode({'location': latLng}, function (results, status) {
      console.log( results ); // TODO: look at other results
      const country = results[ results.length - 1 ].formatted_address;

      var infowindow = new google.maps.InfoWindow({
        content: country + '<button>delete</button>'
      });
      marker.addListener('click', function() {
        infowindow.open(map, marker);
      });

      $.ajax({
          type: "POST",
          url: '/locations',
          data:  {
            latitude: latLng.lat(),
            longitude: latLng.lng(),
            country: country
          },
      });
    })

    return marker;
  }

  function setMapOnAll(map) {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
    }
  }

  function clearMarkers() {
    setMapOnAll(null);
  }

  // Shows any markers currently in the array.
  function showMarkers() {
    setMapOnAll(map);
  }

  // Deletes all markers in the array by removing references to them.
  function deleteMarkers() {
    clearMarkers();
    markers = [];
  }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWU51sQzS9yUoJMfeXtXIyu5MG4uSJB9o&callback=initMap" async defer></script>
